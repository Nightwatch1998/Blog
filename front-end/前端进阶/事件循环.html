<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>事件循环 | NightWatch</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/images/favicon.png">
    <meta name="description" content="编程，从入门到入土">
    
    <link rel="preload" href="/assets/css/0.styles.34aacdd0.css" as="style"><link rel="preload" href="/assets/js/app.0e93a222.js" as="script"><link rel="preload" href="/assets/js/2.994b757b.js" as="script"><link rel="preload" href="/assets/js/57.56ecc18c.js" as="script"><link rel="prefetch" href="/assets/js/10.b0dc23ab.js"><link rel="prefetch" href="/assets/js/11.a54da59e.js"><link rel="prefetch" href="/assets/js/12.ad25fb77.js"><link rel="prefetch" href="/assets/js/13.4106a679.js"><link rel="prefetch" href="/assets/js/14.83569b2f.js"><link rel="prefetch" href="/assets/js/15.d9426698.js"><link rel="prefetch" href="/assets/js/16.0ea418d9.js"><link rel="prefetch" href="/assets/js/17.93130a54.js"><link rel="prefetch" href="/assets/js/18.793eab1a.js"><link rel="prefetch" href="/assets/js/19.8ce14e6a.js"><link rel="prefetch" href="/assets/js/20.f5c4c435.js"><link rel="prefetch" href="/assets/js/21.448e3faa.js"><link rel="prefetch" href="/assets/js/22.c770b4a9.js"><link rel="prefetch" href="/assets/js/23.4bf911cc.js"><link rel="prefetch" href="/assets/js/24.415d2520.js"><link rel="prefetch" href="/assets/js/25.460a3daf.js"><link rel="prefetch" href="/assets/js/26.da97e4f0.js"><link rel="prefetch" href="/assets/js/27.a310b475.js"><link rel="prefetch" href="/assets/js/28.80ab6835.js"><link rel="prefetch" href="/assets/js/29.c50def65.js"><link rel="prefetch" href="/assets/js/3.be02ba24.js"><link rel="prefetch" href="/assets/js/30.14e8903d.js"><link rel="prefetch" href="/assets/js/31.51574d37.js"><link rel="prefetch" href="/assets/js/32.66bdf70f.js"><link rel="prefetch" href="/assets/js/33.8fa7e647.js"><link rel="prefetch" href="/assets/js/34.768dbfc4.js"><link rel="prefetch" href="/assets/js/35.32884803.js"><link rel="prefetch" href="/assets/js/36.1388fb52.js"><link rel="prefetch" href="/assets/js/37.a32b014d.js"><link rel="prefetch" href="/assets/js/38.e8dc87b2.js"><link rel="prefetch" href="/assets/js/39.7f08ca37.js"><link rel="prefetch" href="/assets/js/4.c69c5b0e.js"><link rel="prefetch" href="/assets/js/40.ca274a04.js"><link rel="prefetch" href="/assets/js/41.402a010e.js"><link rel="prefetch" href="/assets/js/42.4730e8dd.js"><link rel="prefetch" href="/assets/js/43.9060fd0f.js"><link rel="prefetch" href="/assets/js/44.dffc8bda.js"><link rel="prefetch" href="/assets/js/45.5c1cdfbe.js"><link rel="prefetch" href="/assets/js/46.ca00c535.js"><link rel="prefetch" href="/assets/js/47.80a6cc1e.js"><link rel="prefetch" href="/assets/js/48.c4f13aa2.js"><link rel="prefetch" href="/assets/js/49.b98c381a.js"><link rel="prefetch" href="/assets/js/5.4dc8d661.js"><link rel="prefetch" href="/assets/js/50.9b5376ac.js"><link rel="prefetch" href="/assets/js/51.aea09ef0.js"><link rel="prefetch" href="/assets/js/52.24e0c0c1.js"><link rel="prefetch" href="/assets/js/53.0ba539b3.js"><link rel="prefetch" href="/assets/js/54.095c64af.js"><link rel="prefetch" href="/assets/js/55.43325a57.js"><link rel="prefetch" href="/assets/js/56.5c920a0c.js"><link rel="prefetch" href="/assets/js/58.c4f8da35.js"><link rel="prefetch" href="/assets/js/59.78206021.js"><link rel="prefetch" href="/assets/js/6.88d03338.js"><link rel="prefetch" href="/assets/js/60.2eb9c400.js"><link rel="prefetch" href="/assets/js/61.f8bb1c72.js"><link rel="prefetch" href="/assets/js/62.a9e5566a.js"><link rel="prefetch" href="/assets/js/63.51657101.js"><link rel="prefetch" href="/assets/js/64.add668a0.js"><link rel="prefetch" href="/assets/js/65.d85324c0.js"><link rel="prefetch" href="/assets/js/66.5dff8bae.js"><link rel="prefetch" href="/assets/js/67.48796b15.js"><link rel="prefetch" href="/assets/js/68.89021cae.js"><link rel="prefetch" href="/assets/js/69.ab54a454.js"><link rel="prefetch" href="/assets/js/7.9de3ff65.js"><link rel="prefetch" href="/assets/js/70.9b023735.js"><link rel="prefetch" href="/assets/js/71.3cbccc78.js"><link rel="prefetch" href="/assets/js/72.ea0dd4b5.js"><link rel="prefetch" href="/assets/js/73.ffea5e88.js"><link rel="prefetch" href="/assets/js/74.627013df.js"><link rel="prefetch" href="/assets/js/75.9e860a97.js"><link rel="prefetch" href="/assets/js/76.6edac978.js"><link rel="prefetch" href="/assets/js/77.1c8d1965.js"><link rel="prefetch" href="/assets/js/78.f568780b.js"><link rel="prefetch" href="/assets/js/79.6b34430e.js"><link rel="prefetch" href="/assets/js/8.8c1df6e1.js"><link rel="prefetch" href="/assets/js/80.d1e4cb25.js"><link rel="prefetch" href="/assets/js/81.17abe4b1.js"><link rel="prefetch" href="/assets/js/82.6ce2141f.js"><link rel="prefetch" href="/assets/js/83.e81dc0b9.js"><link rel="prefetch" href="/assets/js/84.0f0cffa8.js"><link rel="prefetch" href="/assets/js/85.1649190a.js"><link rel="prefetch" href="/assets/js/86.d483f9dd.js"><link rel="prefetch" href="/assets/js/87.b8dfb286.js"><link rel="prefetch" href="/assets/js/88.2233c056.js"><link rel="prefetch" href="/assets/js/89.4f5e8503.js"><link rel="prefetch" href="/assets/js/9.6db7ff72.js"><link rel="prefetch" href="/assets/js/90.2c820ea1.js"><link rel="prefetch" href="/assets/js/91.5648ed51.js"><link rel="prefetch" href="/assets/js/92.7d637862.js"><link rel="prefetch" href="/assets/js/93.afc2446e.js"><link rel="prefetch" href="/assets/js/94.ad5bc1d2.js"><link rel="prefetch" href="/assets/js/95.8563dde0.js"><link rel="prefetch" href="/assets/js/96.18c24280.js"><link rel="prefetch" href="/assets/js/97.7771d9ab.js">
    <link rel="stylesheet" href="/assets/css/0.styles.34aacdd0.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">NightWatch</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端开发" class="dropdown-title"><span class="title">前端开发</span> <span class="arrow down"></span></button> <button type="button" aria-label="前端开发" class="mobile-dropdown-title"><span class="title">前端开发</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/front-end/Basic/" class="nav-link">
  前端基础
</a></li><li class="dropdown-item"><!----> <a href="/front-end/React/" class="nav-link">
  React
</a></li><li class="dropdown-item"><!----> <a href="/front-end/Vue/" class="nav-link">
  Vue
</a></li><li class="dropdown-item"><!----> <a href="/front-end/前端工程化/" class="nav-link">
  前端工程化
</a></li><li class="dropdown-item"><!----> <a href="/front-end/性能优化/" class="nav-link">
  性能优化
</a></li><li class="dropdown-item"><!----> <a href="/front-end/数据格式/" class="nav-link">
  数据格式
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="后端开发" class="dropdown-title"><span class="title">后端开发</span> <span class="arrow down"></span></button> <button type="button" aria-label="后端开发" class="mobile-dropdown-title"><span class="title">后端开发</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/back-end/environment/" class="nav-link">
  环境配置
</a></li><li class="dropdown-item"><!----> <a href="/back-end/mysql/" class="nav-link">
  MySQL数据库
</a></li><li class="dropdown-item"><!----> <a href="/back-end/python/" class="nav-link">
  Python
</a></li><li class="dropdown-item"><!----> <a href="/back-end/springboot/" class="nav-link">
  SpringBoot
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GIS开发" class="dropdown-title"><span class="title">GIS开发</span> <span class="arrow down"></span></button> <button type="button" aria-label="GIS开发" class="mobile-dropdown-title"><span class="title">GIS开发</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/gis/GIS原理/" class="nav-link">
  GIS原理
</a></li><li class="dropdown-item"><!----> <a href="/gis/WebGIS/" class="nav-link">
  WebGIS开发
</a></li><li class="dropdown-item"><!----> <a href="/gis/地图学/" class="nav-link">
  地图学
</a></li><li class="dropdown-item"><!----> <a href="/gis/数据库/" class="nav-link">
  数据库
</a></li><li class="dropdown-item"><!----> <a href="/gis/tools/" class="nav-link">
  GIS工具
</a></li></ul></div></div><div class="nav-item"><a href="/rong/" class="nav-link">
  Rong
</a></div><div class="nav-item"><a href="/others/" class="nav-link">
  其他
</a></div><div class="nav-item"><a href="/test/1.html" class="nav-link">
  测试
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端开发" class="dropdown-title"><span class="title">前端开发</span> <span class="arrow down"></span></button> <button type="button" aria-label="前端开发" class="mobile-dropdown-title"><span class="title">前端开发</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/front-end/Basic/" class="nav-link">
  前端基础
</a></li><li class="dropdown-item"><!----> <a href="/front-end/React/" class="nav-link">
  React
</a></li><li class="dropdown-item"><!----> <a href="/front-end/Vue/" class="nav-link">
  Vue
</a></li><li class="dropdown-item"><!----> <a href="/front-end/前端工程化/" class="nav-link">
  前端工程化
</a></li><li class="dropdown-item"><!----> <a href="/front-end/性能优化/" class="nav-link">
  性能优化
</a></li><li class="dropdown-item"><!----> <a href="/front-end/数据格式/" class="nav-link">
  数据格式
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="后端开发" class="dropdown-title"><span class="title">后端开发</span> <span class="arrow down"></span></button> <button type="button" aria-label="后端开发" class="mobile-dropdown-title"><span class="title">后端开发</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/back-end/environment/" class="nav-link">
  环境配置
</a></li><li class="dropdown-item"><!----> <a href="/back-end/mysql/" class="nav-link">
  MySQL数据库
</a></li><li class="dropdown-item"><!----> <a href="/back-end/python/" class="nav-link">
  Python
</a></li><li class="dropdown-item"><!----> <a href="/back-end/springboot/" class="nav-link">
  SpringBoot
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GIS开发" class="dropdown-title"><span class="title">GIS开发</span> <span class="arrow down"></span></button> <button type="button" aria-label="GIS开发" class="mobile-dropdown-title"><span class="title">GIS开发</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/gis/GIS原理/" class="nav-link">
  GIS原理
</a></li><li class="dropdown-item"><!----> <a href="/gis/WebGIS/" class="nav-link">
  WebGIS开发
</a></li><li class="dropdown-item"><!----> <a href="/gis/地图学/" class="nav-link">
  地图学
</a></li><li class="dropdown-item"><!----> <a href="/gis/数据库/" class="nav-link">
  数据库
</a></li><li class="dropdown-item"><!----> <a href="/gis/tools/" class="nav-link">
  GIS工具
</a></li></ul></div></div><div class="nav-item"><a href="/rong/" class="nav-link">
  Rong
</a></div><div class="nav-item"><a href="/others/" class="nav-link">
  其他
</a></div><div class="nav-item"><a href="/test/1.html" class="nav-link">
  测试
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>前端进阶</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/front-end/前端进阶/事件循环.html" class="active sidebar-link">事件循环</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/front-end/前端进阶/事件循环.html#浏览器的进程模型" class="sidebar-link">浏览器的进程模型</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/front-end/前端进阶/事件循环.html#何为进程" class="sidebar-link">何为进程？</a></li><li class="sidebar-sub-header"><a href="/front-end/前端进阶/事件循环.html#何为线程" class="sidebar-link">何为线程？</a></li><li class="sidebar-sub-header"><a href="/front-end/前端进阶/事件循环.html#浏览器有哪些进程和线程" class="sidebar-link">浏览器有哪些进程和线程？</a></li></ul></li><li class="sidebar-sub-header"><a href="/front-end/前端进阶/事件循环.html#渲染主线程是如何工作的" class="sidebar-link">渲染主线程是如何工作的？</a></li><li class="sidebar-sub-header"><a href="/front-end/前端进阶/事件循环.html#若干解释" class="sidebar-link">若干解释</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/front-end/前端进阶/事件循环.html#何为异步" class="sidebar-link">何为异步？</a></li><li class="sidebar-sub-header"><a href="/front-end/前端进阶/事件循环.html#js为何会阻碍渲染" class="sidebar-link">JS为何会阻碍渲染？</a></li><li class="sidebar-sub-header"><a href="/front-end/前端进阶/事件循环.html#任务有优先级吗" class="sidebar-link">任务有优先级吗？</a></li></ul></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="事件循环"><a href="#事件循环" class="header-anchor">#</a> 事件循环</h1> <h2 id="浏览器的进程模型"><a href="#浏览器的进程模型" class="header-anchor">#</a> 浏览器的进程模型</h2> <h3 id="何为进程"><a href="#何为进程" class="header-anchor">#</a> 何为进程？</h3> <p>程序运行需要的<strong>专属内存空间</strong></p> <p>每个应用至少有一个进程，进程之间互相独立，即使要通信，也需要双方同意。</p> <h3 id="何为线程"><a href="#何为线程" class="header-anchor">#</a> 何为线程？</h3> <p>一个进程至少有一个进程，进程开启后会自动创建一个线程来运行代码，该线程称为主线程。</p> <p>如果程序需要同时执行多块代码，主线程就会启动更多的线程来执行代码，所以一个进程可以包含多个线程。</p> <h3 id="浏览器有哪些进程和线程"><a href="#浏览器有哪些进程和线程" class="header-anchor">#</a> 浏览器有哪些进程和线程？</h3> <p>浏览器内部工作极其复杂。</p> <p>为了避免互相影响，为了减少连环崩溃的几率，当启动浏览器后，它会自动启动多个进程。</p> <p>其中主要的进程有：</p> <ol><li>浏览器进程</li></ol> <p>主要负责界面显示、用户交互、子进程管理。浏览器进程内部会启动多个线程处理不同任务。</p> <ol start="2"><li>网络进程</li></ol> <p>负责加载网络资源。网络进程内部会启动多个线程来处理不同的网络任务。</p> <ol start="3"><li><strong>渲染进程</strong></li></ol> <p>渲染进程会开启一个渲染主线程，主线程负责执行HTML、CSS、JS代码。</p> <p>默认情况下，浏览器会为每个标签页开启一个全新的渲染进程，以保证不同的标签页之间不相互影响。</p> <h2 id="渲染主线程是如何工作的"><a href="#渲染主线程是如何工作的" class="header-anchor">#</a> 渲染主线程是如何工作的？</h2> <p>需要处理的任务：</p> <ul><li>解析HTML</li> <li>解析CSS</li> <li>计算样式</li> <li>布局</li> <li>处理图层</li> <li>每秒把页面画60次</li> <li>执行全局JS代码</li> <li>执行事件处理函数</li> <li>执行计时器的回调函数</li></ul> <p><img src="https://stag-blog.oss-cn-beijing.aliyuncs.com/picture/202208092230847.png" alt="202208092230847"></p> <p>渲染主线程如何调度这些任务？事件队列</p> <ol><li>在最开始的时候，渲染主线程会进入一个无限循环</li> <li>每一次循环会检查队列中是否有任务存在，如果有，就取出第一个任务执行，执行完一个后进入下一次循环；如果没有，则进入休眠状态。</li> <li>其他所有线程可以随时向消息队列添加任务，新任务会加到队列的末尾。添加新任务时，如果主线程是休眠状态，则会将其唤醒以继续循环拿任务。</li></ol> <h2 id="若干解释"><a href="#若干解释" class="header-anchor">#</a> 若干解释</h2> <h3 id="何为异步"><a href="#何为异步" class="header-anchor">#</a> 何为异步？</h3> <p>代码执行过程中，会遇到一些无法立即处理的任务，比如：</p> <ul><li>计时完成后需要执行的任务：<code>setTimeout</code>、<code>setInterval</code></li> <li>网络通信完成后需要执行的任务：<code>XHR</code>、<code>Fetch</code></li> <li>用户操作后需要执行的任务：<code>addEventListener</code></li></ul> <p>同步方式处理：</p> <p><img src="https://stag-blog.oss-cn-beijing.aliyuncs.com/picture/202208101043348.png" alt="202208101043348"></p> <p><strong>渲染主线程承担着极其重要的工作，无论如何都不能阻塞！</strong></p> <p>因此，浏览器使用异步来解决这个问题：</p> <p><img src="https://stag-blog.oss-cn-beijing.aliyuncs.com/picture/202208101048899.png" alt="202208101048899"></p> <p>使用异步的方式，<strong>渲染主线程永不阻塞</strong></p> <blockquote><p>面试题：如何理解JS的异步？</p> <p><strong>JS是一门单线程语言</strong>，这是因为它运行在浏览器的渲染主线程中，而渲染主线程只有一个。</p> <p>而渲染主线程承担着诸多的工作，渲染页面、执行JS都在其中运行。</p> <p>如果使用同步的方式，就极有可能导致<strong>主线程阻塞</strong>，从而导致消息队列中的很多其他任务无法得到执行。</p> <p>这样，主线程会白白浪费时间，另一方面导致页面无法及时更新，给用户造成卡死的现象。</p> <p>所以<strong>浏览器采用异步</strong>的方式来避免。具体做法是当某些任务发生时，比如计时器、网络请求、时间监听，主线程将任务交给其他线程去处理，自身立即结束任务的执行，转而执行其它代码。当其他线程完成后，<strong>将事先传递的回调函数包装成任务</strong>，加入消息队列的末尾排队，等待主线程调度执行。</p> <p>这种异步模式下，浏览器永不阻塞，最大限度的保证了单线程的流畅运行。</p></blockquote> <h3 id="js为何会阻碍渲染"><a href="#js为何会阻碍渲染" class="header-anchor">#</a> JS为何会阻碍渲染？</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> h1 <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'h1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> btn <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'button'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 死循环指定的时间</span>
<span class="token keyword">function</span> <span class="token function">delay</span><span class="token punctuation">(</span><span class="token parameter">duration</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> start <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start <span class="token operator">&lt;</span> duration<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

btn<span class="token punctuation">.</span><span class="token function-variable function">onclick</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  h1<span class="token punctuation">.</span>textContent <span class="token operator">=</span> <span class="token string">'袁老师很帅！'</span><span class="token punctuation">;</span>
  <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>代码执行后会发生什么？</p> <p>主线程执行到onclick会通知其他线程开启定时器，定时器结束后，把对应的函数fn放入消息队列。随后渲染主线程取出fn，执行到<code>h1.textContent = '袁老师很帅！';</code>会在消息队列末尾添加一个渲染任务，等阻塞3秒后，fn执行完毕，会执行渲染任务</p> <h3 id="任务有优先级吗"><a href="#任务有优先级吗" class="header-anchor">#</a> 任务有优先级吗？</h3> <p>任务没有优先级，在消息队列中先进先出</p> <p><strong>但消息队列是有优先级的</strong>：</p> <ul><li>每个任务都有一个任务类型，同类任务必须在一个队列，不同类的任务可以在不同队列</li> <li>浏览器必须准备好一个微队列，微队列中的任务<strong>优先</strong>执行所有其他任务执行</li></ul> <p>在目前Chrome的实现中，至少包含了下面的队列：</p> <ul><li>延时队列：用于存放计时器到达后的回调任务，优先级<code>中</code></li> <li>交互队列：用于存放用户操作后产生的事件处理任务，优先级<code>高</code></li> <li>微队列：用户存放需要最快执行的任务，优先级<code>最高</code></li></ul> <p>添加微队列的主要方式：<code>Promise</code>、<code>MutationObserver</code></p> <div class="language-js extra-class"><pre class="language-js"><code>Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>函数<span class="token punctuation">)</span>
</code></pre></div><blockquote><p>浏览器还有很多其他队列，和开发关系不大，不作考虑</p></blockquote> <blockquote><p>面试题：阐述一下JS的事件循环</p> <p>事件循环又叫做消息循环，是浏览器渲染主线程的工作方式。</p> <p>在Chrome的源码中，它开启一个不会结束的for循环，每次循环从消息队列中<strong>取出第一个任务</strong>执行，而其他线程只需在合适的时候将任务<strong>添加在队列末尾</strong>即可。</p> <p>过去把消息队列简单分为宏队列和微队列，这种说法目前已经无法满足复杂的浏览器环境，取而代之的是一种灵活多变的处理方式。</p> <p>根据W3C官方的解释，每个任务有不同的类型，同类型的任务必须在同一个队列，不同任务可以属于不同队列。不同任务队列有不同的优先级，在一次事件循环中，由浏览器自行决定取哪一个队列的任务。但浏览器<strong>必须要有一个微队列</strong>，微队列的任务一定具有最高的优先级，必须优先调度执行。</p></blockquote> <p>一个例子说明交互任务比延时任务更重要</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>en<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>UTF-8<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>X-UA-Compatible<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>IE=edge<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>viewport<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>width=device-width, initial-scale=1.0<span class="token punctuation">&quot;</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>Document<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>begin<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>开始<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>interaction<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>添加交互任务<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
      <span class="token comment">// 死循环指定的时间</span>
      <span class="token keyword">function</span> <span class="token function">delay</span><span class="token punctuation">(</span><span class="token parameter">duration</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> start <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start <span class="token operator">&lt;</span> duration<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">function</span> <span class="token function">addDelay</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'添加延时队列'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'延时队列执行'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">function</span> <span class="token function">addInteraction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'添加交互队列'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        interaction<span class="token punctuation">.</span><span class="token function-variable function">onclick</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'交互队列执行'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      begin<span class="token punctuation">.</span><span class="token function-variable function">onclick</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">addDelay</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">addInteraction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'==========='</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>

</code></pre></div><p>说明：点击开始后，立即点击添加交互任务，控制台打印，先添加延时任务，再添加交互任务，最终先执行了交互任务，再执行延时任务。</p> <blockquote><p>面试题：JS中的计时器能做到精确计时吗？</p> <p>不能，因为：</p> <ol><li>计算机硬件没有原子钟，无法精确计时</li> <li>操作系统的计时函数本身有少量偏差，JS的计时器最终调用的是操作系统的函数，就懈怠了这部分偏差。</li> <li>按照W3C标准，浏览器实现计时器，如果嵌套层级超过5层，会带有4毫秒的最少时间，又造成了偏差</li> <li>收到事件循环影响，计时器的回调函数只能在<strong>主线程空闲时</strong>运行，因此又带来了误差。</li></ol></blockquote></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">6/20/2024, 3:16:57 PM</span></div></footer> <!----> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.0e93a222.js" defer></script><script src="/assets/js/2.994b757b.js" defer></script><script src="/assets/js/57.56ecc18c.js" defer></script>
  </body>
</html>
